<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ID Scanner & Export to Word</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f4f9;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
      flex-direction: column;
    }
    h1 {
      color: #333;
    }
    #video {
      border: 2px solid #333;
      border-radius: 8px;
      width: 90%;
      max-width: 600px;
      margin-bottom: 20px;
    }
    #capture-button {
      padding: 15px 30px;
      font-size: 18px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    #capture-button:hover {
      background-color: #45a049;
    }
    #result {
      margin-top: 30px;
      font-size: 18px;
      color: #333;
      text-align: center;
      max-width: 600px;
      width: 90%;
      background-color: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      word-wrap: break-word;
    }
  </style>
</head>
<body>
  <h1>Scan Your ID Card</h1>
  <video id="video" width="100%" height="auto" autoplay></video>
  <button id="capture-button">Capture ID</button>
  <div id="result">Your extracted information will appear here.</div>
  <button id="download-button" style="display:none;">Download as Word</button>

  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@2.0.0-beta.4"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pizzip/3.0.6/pizzip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.21.0/docxtemplater.js"></script>

  <script>
    const video = document.getElementById("video");
    const captureButton = document.getElementById("capture-button");
    const resultDiv = document.getElementById("result");
    const downloadButton = document.getElementById("download-button");

    // Start video stream from the camera
    navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
      .then(stream => {
        video.srcObject = stream;
      })
      .catch(err => {
        console.error("Error accessing the camera: ", err);
      });

    captureButton.addEventListener("click", () => {
      const canvas = document.createElement("canvas");
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      // Run OCR on the captured image
      Tesseract.recognize(
        canvas,
        'eng',
        {
          logger: info => console.log(info),
        }
      ).then(({ data: { text } }) => {
        // Display extracted text
        resultDiv.innerHTML = `
          <h3>Extracted Information:</h3>
          <p><strong>Text Found:</strong><br>${text}</p>
        `;
        
        // Extract ismi, familiyasi, tugilgan sanasi if possible
        const extractedData = extractData(text);

        if (extractedData) {
          resultDiv.innerHTML += `
            <h3>Parsed Data:</h3>
            <p><strong>Name:</strong> ${extractedData.name}</p>
            <p><strong>Surname:</strong> ${extractedData.surname}</p>
            <p><strong>Date of Birth:</strong> ${extractedData.dob}</p>
          `;
          
          downloadButton.style.display = "block"; // Show download button
        }
      }).catch(error => {
        resultDiv.innerHTML = "Error extracting text from image.";
      });
    });

    downloadButton.addEventListener("click", () => {
      const extractedData = extractData(resultDiv.innerHTML);

      const doc = new PizZip();
      const template = `
        <w:document xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main">
          <w:body>
            <w:p><w:r><w:t>Name: ${extractedData.name}</w:t></w:r></w:p>
            <w:p><w:r><w:t>Surname: ${extractedData.surname}</w:t></w:r></w:p>
            <w:p><w:r><w:t>Date of Birth: ${extractedData.dob}</w:t></w:r></w:p>
          </w:body>
        </w:document>
      `;

      const docx = new docxtemplater(doc, { zip: new PizZip() });

      docx.render();
      const content = docx.getZip().generate({ type: "blob" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(content);
      link.download = "ID_Extracted_Data.docx";
      link.click();
    });

    function extractData(text) {
      const regexName = /([A-Za-z]+)\s([A-Za-z]+)/;
      const regexDob = /(\d{2}\/\d{2}\/\d{4})/;
      const matchName = text.match(regexName);
      const matchDob = text.match(regexDob);

      if (matchName && matchDob) {
        return {
          name: matchName[1],
          surname: matchName[2],
          dob: matchDob[0],
        };
      }

      return null;
    }
  </script>
</body>
</html>
